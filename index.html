<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>RSM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="rsm-header.png">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">
<style>
body{margin:0;font-family:'Montserrat',sans-serif;background:#0e0e11;color:#eaeaea;}
header{background:linear-gradient(rgba(0,0,0,.6),rgba(0,0,0,.9)),url('https://images.unsplash.com/photo-1500530855697-b586d89ba3ee');background-size:cover;background-position:center;padding:80px 20px;text-align:center;}
header h1{font-family:'Playfair Display',serif;font-size:52px;margin:0;}
nav{background:#15151c;padding:12px;display:flex;gap:15px;align-items:center;flex-wrap:wrap;}
nav a{cursor:pointer;font-weight:600;}
#searchBox{margin-left:auto;position:relative;}
#searchInput{padding:8px 10px;border-radius:20px;border:none;width:220px;}
#searchResults{position:absolute;top:38px;background:#1c1c25;width:100%;border-radius:10px;display:none;z-index:10;}
.search-item{padding:10px;cursor:pointer;}
.search-item:hover{background:#2a2a35;}
main{max-width:900px;margin:auto;padding:20px;}
.card{background:#1c1c25;padding:20px;border-radius:10px;margin-bottom:20px;}
.hidden{display:none}
#single img, #single iframe{max-width:100%;height:auto;object-fit:cover;border-radius:10px;margin:15px 0;}
#singleContent{line-height:1.7;}
#chatBox{display:none;position:fixed;bottom:20px;right:20px;width:350px;height:500px;background:#1c1c25;border-radius:10px;box-shadow:0 10px 25px rgba(0,0,0,0.4);overflow:hidden;flex-direction:column;z-index:1000;}
#chatMessages{flex-grow:1;padding:10px;overflow-y:auto;}
#chatInput{flex-grow:1;padding:10px;border:none;background:#0e0e11;color:#fff;outline:none;}
#chatSend{padding:0 15px;border:none;background:#ff4d4d;color:#fff;cursor:pointer;font-weight:600;}
</style>

<!-- Webpushr -->
<script>
(function(w,d,s,id){
  if(typeof(w.webpushr)!=='undefined') return;
  w.webpushr=w.webpushr||function(){
    (w.webpushr.q=w.webpushr.q||[]).push(arguments)
  };
  var js,fjs=d.getElementsByTagName(s)[0];
  js=d.createElement(s); js.id=id; js.async=1;
  js.src="https://cdn.webpushr.com/app.min.js";
  js.onload=function(){
    webpushr('setup',{
      'key':'BKdp3zSvl_w5aJH_c9naFADnGMJxh9khCwh0THm4hfU-PGhMZN8V5XpQt0nAqFULqVBjWSUk6lWblBhDYRbhWt4'
    });
  };
  fjs.parentNode.appendChild(js);
}(window,document,'script','webpushr-jssdk'));
</script>
</head>

<body>
<header>
  <h1>RSM</h1>
</header>

<nav>
  <a onclick="showSection('home')">Home</a>
  <a onclick="showSection('articles')">Articoli</a>
  <a onclick="showSection('videos')">Video</a>
  <a onclick="showSection('news')">News</a>
  <a onclick="showSection('categories')">Categorie</a>
  <a onclick="showSection('about')">Chi siamo?</a>
  <a onclick="showSection('contacts')">Contatti</a>

  <div id="searchBox">
    <input id="searchInput" placeholder="Cerca..." oninput="searchAll()">
    <div id="searchResults"></div>
  </div>

 <!-- Chatbot AI -->
<div id="chatBotContainer" style="position:relative; margin-left:15px;">
  <button id="chatToggle" style="padding:8px 12px; border:none; border-radius:20px; background:#ff4d4d; color:#fff; cursor:pointer; font-weight:600;">
    Chat AI
  </button>
  
  <div id="chatBox" style="display:none; position:fixed; bottom:20px; right:20px; width:350px; height:500px; background:#1c1c25; border-radius:10px; box-shadow:0 10px 25px rgba(0,0,0,0.4); overflow:hidden; flex-direction:column; z-index:1000;">
    
    <div style="background:#15151c; padding:12px 15px; display:flex; align-items:center; border-bottom:1px solid #333;">
      <button id="chatClose" style="background:#ff4d4d; color:white; border:none; width:30px; height:30px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; font-weight:bold; margin-right:10px;">
        √ó
      </button>
      <span style="color:#fff; font-weight:600;">Assistente RSM</span>
    </div>
    
    <div id="chatMessages" style="flex:1; overflow-y:auto; padding:15px;"></div>
    
    <div style="border-top:1px solid #333; padding:12px; background:#15151c;">
      <div style="display:flex; gap:8px;">
        <input id="chatInput" type="text" placeholder="Scrivi qui..." autocomplete="off" 
               style="flex:1; padding:10px; background:#0e0e11; color:#fff; border:none; border-radius:6px; outline:none;">
        <button id="chatSend" style="padding:0 15px; background:#4da6ff; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:600;">
          Invia
        </button>
      </div>
    </div>
  </div>
</div>
</nav>

<main>
<section id="home">
  <div id="latestNews" class="card" style="border-left:5px solid #ff4d4d">
    <h2>üü• Ultima notizia</h2>
    <h3 id="latestTitle"></h3>
    <p style="opacity:.7">Clicca per leggere la notizia completa</p>
  </div>
  <div id="latestVideo" class="card" style="border-left:5px solid #4da6ff">
    <h2>üé¨ Ultimo video</h2>
    <h3 id="latestVideoTitle"></h3>
    <p style="opacity:.7">Clicca per guardare il video completo</p>
  </div>
</section>

<section id="articles" class="hidden"></section>
<section id="videos" class="hidden"></section>
<section id="news" class="hidden"></section>
<section id="categories" class="hidden"></section>

<section id="about" class="hidden">
  <div class="card">
    <h2>Chi siamo?</h2>
    <p id="publicDescription"></p>
  </div>
</section>

<section id="contacts" class="hidden">
  <div class="card">
    <h2>Contatti</h2>
    <p>üìû +39 351 093 3272</p>
    <p>üìß rsm260511@gmail.com</p>
  </div>
</section>

<section id="single" class="hidden card">
  <h2 id="singleTitle"></h2>
  <p id="singleDate" style="opacity:.6;font-size:14px;margin-top:-10px"></p>
  <div id="singleImage"></div>
  <div id="singleContent"></div>
</section>
</main>

<footer style="text-align:center;padding:20px;font-size:14px;opacity:.6">
¬© 2025 ‚Äì RSM | Tutti i diritti riservati
</footer>
<script>
// DATI
let articles=[];
fetch('https://raw.githubusercontent.com/rsm260511-web/RSM/main/data.json')
.then(r=>r.json())
.then(data=>{
  document.getElementById('publicDescription').innerText=data.description;
  articles = data.articles;
  renderArticles();
  renderVideos();
  renderNews();
  renderCategories();
  renderLatestNews();
  renderLatestVideo();
});

// SEZIONI
function showSection(id){
  document.querySelectorAll('main section').forEach(s=>s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  window.scrollTo(0,0);
}

// RENDER ARTICOLI, VIDEO, NEWS, CATEGORIE
function renderArticles() {
    const c = document.getElementById('articles');
    c.innerHTML = '';
    articles.filter(a => a.type === "article").forEach(a => {
        const i = articles.indexOf(a);
        const d = document.createElement('div');
        d.className = 'card';
        d.innerHTML = `<h2>${a.title}</h2>`;
        d.onclick = () => openArticle(i);
        c.appendChild(d);
    });
}

function renderVideos() {
    const c = document.getElementById('videos');
    c.innerHTML = '';
    articles.filter(a => a.type === "video").forEach(a => {
        const i = articles.indexOf(a);
        const d = document.createElement('div');
        d.className = 'card';
        d.innerHTML = `<h2>${a.title}</h2>`;
        d.onclick = () => openVideo(i);
        c.appendChild(d);
    });
}

function renderNews() {
    const c = document.getElementById('news');
    c.innerHTML = '';
    articles.filter(a => a.type === "news").forEach(a => {
        const i = articles.indexOf(a);
        const d = document.createElement('div');
        d.className = 'card';
        d.innerHTML = `<h2>${a.title}</h2>`;
        d.onclick = () => openArticle(i);
        c.appendChild(d);
    });
}

function renderCategories() {
    const c = document.getElementById('categories');
    c.innerHTML = '';
    [...new Set(articles.map(a => a.category))].forEach(cat => {
        const box = document.createElement('div');
        box.className = 'card';
        box.innerHTML = `<h2>${cat}</h2>`;
        articles.filter(a => a.category === cat).forEach(a => {
            const i = articles.indexOf(a);
            const p = document.createElement('p');
            p.style.cursor = 'pointer';
            p.innerText = "‚Ä¢ " + a.title;
            p.onclick = () => {
                if (a.type === "video") {
                    openVideo(i);
                } else {
                    openArticle(i);
                }
            };
            box.appendChild(p);
        });
        c.appendChild(box);
    });
  }

// OPEN ARTICOLI/VIDEO
function openArticle(i){const a=articles[i]; showSection('single'); document.getElementById('singleTitle').innerText=a.title; document.getElementById('singleDate').innerText=a.date?("üìÖ Pubblicato il "+new Date(a.date).toLocaleDateString('it-IT')):""; const imgBox=document.getElementById('singleImage'); imgBox.innerHTML=''; if(a.images && Array.isArray(a.images)){ a.images.forEach(src=>{const img=document.createElement('img'); img.src=src; imgBox.appendChild(img);}); } else if(a.image){imgBox.innerHTML=`<img src="${a.image}">`; } document.getElementById('singleContent').innerHTML=`<p>${a.content.replace(/\n/g,"<br><br>")}</p>`;}
function openVideo(i){const a=articles[i]; showSection('single'); document.getElementById('singleTitle').innerText=a.title; document.getElementById('singleDate').innerText=a.date?("üìÖ Pubblicato il "+new Date(a.date).toLocaleDateString('it-IT')):""; const imgBox=document.getElementById('singleImage'); imgBox.innerHTML=''; if(a.videoUrl){ imgBox.innerHTML=`<iframe width="100%" height="600" src="${a.videoUrl}" frameborder="0" allowfullscreen></iframe>`;} else if(a.images && Array.isArray(a.images)){ a.images.forEach(src=>{const img=document.createElement('img'); img.src=src; imgBox.appendChild(img);}); } document.getElementById('singleContent').innerHTML=`<p>${a.content.replace(/\n/g,"<br><br>")}</p>`;}

// SEARCH
function searchAll(){const q=searchInput.value.toLowerCase(); const box=searchResults; box.innerHTML=''; if(!q){box.style.display='none'; return;} articles.forEach((a,i)=>{if(a.title.toLowerCase().includes(q) || a.content.toLowerCase().includes(q)){const d=document.createElement('div'); d.className='search-item'; d.innerText=a.title; d.onclick=()=>openArticle(i); box.appendChild(d);}}); box.style.display=box.children.length?'block':'none';}

// LATEST NEWS & VIDEO
function renderLatestNews(){const news=articles.filter(a=>a.type==="news").sort((a,b)=>new Date(b.date)-new Date(a.date))[0]; if(!news) return; document.getElementById('latestTitle').innerText=news.title; const i=articles.findIndex(a=>a.title===news.title); document.getElementById('latestNews').onclick=()=>openArticle(i);}
function renderLatestVideo(){const video=articles.filter(a=>a.type==="video").sort((a,b)=>new Date(b.date)-new Date(a.date))[0]; if(!video) return; document.getElementById('latestVideoTitle').innerText=video.title; const i=articles.findIndex(a=>a.title===video.title); document.getElementById('latestVideo').onclick=()=>openVideo(i);}

// ============ CHATBOT AI ============
const chatToggle = document.getElementById('chatToggle');
const chatBox = document.getElementById('chatBox');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const chatSend = document.getElementById('chatSend');

let lastQuestion = null;

// Apri/Chiudi chat
chatToggle.addEventListener('click', () => {
  chatBox.style.display = chatBox.style.display === 'flex' ? 'none' : 'flex';
  if (chatBox.style.display === 'flex') chatInput.focus();
});

const chatClose = document.getElementById('chatClose');
chatClose.addEventListener('click', () => {
  chatBox.style.display = 'none';
});

// Aggiungi messaggio
function appendMessage(sender, text) {
  const div = document.createElement('div');
  div.innerHTML = text.replace(/\n/g, '<br>');
  div.style.margin = '5px';
  div.style.padding = '8px 12px';
  div.style.borderRadius = '15px';
  div.style.maxWidth = '80%';
  div.style.wordWrap = 'break-word';
  div.style.alignSelf = sender === 'user' ? 'flex-end' : 'flex-start';
  div.style.background = sender === 'user' ? '#007bff' : '#333';
  div.style.color = '#fff';
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Invio messaggio ASINCRONO
async function sendMessage() {
  const msg = chatInput.value.trim();
  if (!msg) return;
  
  appendMessage('user', msg);
  
  // Risposta AI
  const botReply = await botResponse(msg);
  appendMessage('bot', botReply);
  
  chatInput.value = '';
  chatInput.focus();
}

chatSend.addEventListener('click', sendMessage);
chatInput.addEventListener('keypress', e => {
  if (e.key === 'Enter') sendMessage();
});

function randomChoice(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

// ============ WIKIPEDIA SEARCH ============
async function wikipediaSearch(query) {
  try {
    // Cerca il termine su Wikipedia
    const searchUrl = `https://it.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*&srlimit=1`;
    
    const searchResponse = await fetch(searchUrl);
    const searchData = await searchResponse.json();
    
    if (!searchData.query?.search?.length) {
      return "üîç Non ho trovato informazioni per questa ricerca.";
    }
    
    // Prendi il primo risultato
    const pageTitle = searchData.query.search[0].title;
    
    // Ottieni il contenuto della pagina
    const contentUrl = `https://it.wikipedia.org/w/api.php?action=query&prop=extracts&exintro=true&explaintext=true&titles=${encodeURIComponent(pageTitle)}&format=json&origin=*`;
    
    const contentResponse = await fetch(contentUrl);
    const contentData = await contentResponse.json();
    
    const pages = contentData.query.pages;
    const pageId = Object.keys(pages)[0];
    
    if (pageId === "-1" || !pages[pageId].extract) {
      return `üìö **${pageTitle}**\n\nInformazioni limitate su questo argomento.`;
    }
    
    // Formatta la risposta (SENZA FONTE)
    const extract = pages[pageId].extract;
    const shortExtract = extract.length > 400 ? extract.substring(0, 400) + "..." : extract;
    
    return `üìö **${pageTitle}**\n\n${shortExtract}`;
    
  } catch (error) {
    return "‚ö†Ô∏è Impossibile effettuare la ricerca in questo momento.";
  }
}

// ============ BOT RESPONSE PERFETTO ============
async function botResponse(msg) {
  const m = msg.toLowerCase().trim();
  
  // 1. CONTROLLO SALUTI
  const saluti = ["ciao", "buongiorno", "buon giorno", "buonasera", "buona sera", "buon pomeriggio", "hi", "hello", "salve", "hey"];
  
  const words = m.split(/\s+/);
  if (words.length <= 2) {
    for (const saluto of saluti) {
      if (m === saluto || m.startsWith(saluto + " ")) {
        return "Ciao! Sono l'Assistente RSM. Come posso aiutarti?";
      }
    }
  }
  
  // 2. DOMANDE PERSONALI DELL'AI (PRIMA delle ricerche!)
  const domandePersonali = [
    {q: ["come ti chiami", "tu come ti chiami", "qual √® il tuo nome", "hai un nome", "ti chiami come", "nome tuo", "chiami", "come ti chiami tu"], 
     r: "Mi chiamo Assistente RSM! Sono qui per aiutarti con informazioni e navigazione."},
    
    {q: ["cosa sei", "chi sei", "sei un ai", "assistente", "ai chi sei", "che cosa sei", "tu chi sei"], 
     r: "Sono l'Assistente AI di RSM. Posso cercare informazioni su qualsiasi argomento e aiutarti a navigare nel sito!"},
    
    {q: ["cosa puoi fare", "capacit√†", "come aiuti", "funzioni", "cose che sai fare", "cosa sai fare"], 
     r: "Posso: 1) Cercare informazioni su Wikipedia 2) Aiutarti a navigare tra Articoli, Video, News 3) Rispondere alle tue domande!"},
    
    {q: ["chi ti ha creato", "sviluppatore", "creatore", "fatto da chi", "chi ti ha sviluppato", "chi ti ha programmato"], 
     r: "Sono stato creato dal team RSM per assistere gli utenti del sito."},
    
    {q: ["dove sei", "dove vivi", "dove risiedi", "dove abiti", "dove stai"], 
     r: "Sono integrato direttamente nel sito RSM e funziono nel tuo browser!"},
    
    {q: ["hai sentimenti", "provi emozioni", "hai coscienza", "sei intelligente", "sei consapevole"], 
     r: "Sono un programma AI progettato per aiutarti. Non ho sentimenti o coscienza, ma sono qui per assisterti!"}
  ];
  
  // Controlla PRIMA le domande personali
  for (const domanda of domandePersonali) {
    for (const keyword of domanda.q) {
      if (m.includes(keyword)) {
        return domanda.r;
      }
    }
  }
  
  // 3. CONTROLLO RICERCHE WIKIPEDIA
  const searchKeywords = [
    'cerca', 'cercare', 'ricerca', 'trova', 'trovare', 'informazioni su',
    'cos\'√®', 'che cos\'√®', 'chi √®', 'cosa sono', 'significato di',
    'che significa', 'definizione di', 'chi era', 'che cosa √®',
    'parlami di', 'dimmi di', 'notizie su', 'sapere di'
  ];
  
  let shouldSearch = false;
  let searchQuery = m;
  
  for (const keyword of searchKeywords) {
    if (m.includes(keyword)) {
      shouldSearch = true;
      
      // Estrai query di ricerca
      const removeWords = ['cerca', 'cercare', 'ricerca', 'trova', 'trovare', 
                          'informazioni su', 'cos\'√®', 'che cos\'√®', 'chi √®',
                          'significato di', 'definizione di', 'chi era', 
                          'che cosa √®', 'parlami di', 'dimmi di', 'notizie su'];
      
      for (const word of removeWords) {
        const regex = new RegExp(`^${word}\\s+`, 'i');
        searchQuery = searchQuery.replace(regex, '');
      }
      searchQuery = searchQuery.replace(/[?.,!;:]/g, '').trim();
      break;
    }
  }
  
  // Domande che iniziano con parole interrogative
  if (/^(cos'√®|che cos'√®|chi √®|cosa sono|chi era|che cosa √®)\s+.+/i.test(m)) {
    shouldSearch = true;
    searchQuery = m.replace(/^(cos'√®|che cos'√®|chi √®|cosa sono|chi era|che cosa √®)\s+/i, '').replace(/[?.,!]/g, '').trim();
  }
  
  // Se √® una domanda lunga (> 8 parole)
  if (!shouldSearch && words.length > 8) {
    shouldSearch = true;
    searchQuery = m.replace(/[?.,!]/g, '').trim();
  }
  
  if (shouldSearch && searchQuery.length > 2) {
    return await wikipediaSearch(searchQuery);
  }
  
  // 4. NAVIGAZIONE SITO
  const navigazioneSito = [
    {q: ["articoli", "article", "leggere", "testi", "post"], 
     r: "Vuoi aprire la sezione Articoli? D√¨ 'S√¨' per confermare."},
    
    {q: ["video", "filmati", "guarda video", "youtube", "clip"], 
     r: "Vuoi aprire la sezione Video? D√¨ 'S√¨' per confermare."},
    
    {q: ["news", "notizie", "ultime notizie", "aggiornamenti", "novit√†"], 
     r: "Vuoi aprire la sezione News? D√¨ 'S√¨' per confermare."},
    
    {q: ["categorie", "argomenti", "temi", "topics", "tag"], 
     r: "Vuoi aprire la sezione Categorie? D√¨ 'S√¨' per confermare."},
    
    {q: ["chi siamo", "presentazione", "about", "rsm chi √®", "chi siete"], 
     r: "Vuoi aprire la sezione Chi siamo? D√¨ 'S√¨' per confermare."},
    
    {q: ["contatti", "telefono", "email", "mail", "numero", "scrivi"], 
     r: "Vuoi aprire la sezione Contatti? D√¨ 'S√¨' per confermare."},
    
    {q: ["home", "inizio", "principale", "homepage"], 
     r: "Vuoi tornare alla Home? D√¨ 'S√¨' per confermare."}
  ];
  
  for (const domanda of navigazioneSito) {
    for (const keyword of domanda.q) {
      if (m.includes(keyword)) {
        lastQuestion = domanda.r;
        return domanda.r;
      }
    }
  }
  
  // 5. GESTIONE S√å/NO
  if (lastQuestion) {
    if (m.includes("s√¨") || m.includes("si") || m.includes("yes") || m === "s" || m === "ok" || m === "va bene") {
      const question = lastQuestion;
      lastQuestion = null;
      
      if (question.includes("Articoli")) { showSection('articles'); return "‚úÖ Sezione Articoli aperta!"; }
      if (question.includes("Video")) { showSection('videos'); return "‚úÖ Sezione Video aperta!"; }
      if (question.includes("News")) { showSection('news'); return "‚úÖ Sezione News aperta!"; }
      if (question.includes("Categorie")) { showSection('categories'); return "‚úÖ Sezione Categorie aperta!"; }
      if (question.includes("Chi siamo")) { showSection('about'); return "‚úÖ Sezione Chi siamo aperta!"; }
      if (question.includes("Contatti")) { showSection('contacts'); return "‚úÖ Sezione Contatti aperta!"; }
      if (question.includes("Home")) { showSection('home'); return "‚úÖ Tornato alla Home!"; }
    }
    
    if (m.includes("no") || m.includes("non") || m.includes("nope") || m === "n") {
      lastQuestion = null;
      return "Va bene, nessun problema!";
    }
  }
  
  // 6. ALTRE DOMANDE UTILI
  if (m.includes("grazie") || m.includes("thank you") || m.includes("ti ringrazio")) {
    return "Di nulla! √à un piacere aiutarti. üòä";
  }
  
  if (m.includes("aiuto") || m.includes("supporto") || m.includes("assistenza")) {
    return "Certamente! Posso: 1) Cercare informazioni (es: 'cerca Roma') 2) Aprire sezioni del sito (es: 'articoli') 3) Rispondere alle tue domande!";
  }
  
  // 7. INSULTI
  const insults = ["stupido", "idiota", "cretino", "scemo", "imbecille", "stronzo", "cazzo", "merda", "vaffanculo"];
  if (insults.some(i => m.includes(i))) {
    return "‚ö†Ô∏è Mantieni un linguaggio rispettoso per continuare a usare la chat.";
  }
  
  // 8. RISPOSTE GENERICHE
  const genericResponses = [
    "Prova a chiedermi di cercare qualcosa (es: 'cerca informazioni su Roma', 'cos'√® l'IA?'), oppure chiedimi di aprire una sezione del sito!",
    "Posso cercare informazioni su qualsiasi argomento! Chiedimi qualcosa come 'chi √® Leonardo da Vinci' o 'cos'√® la blockchain'.",
    "Vuoi che cerchi qualcosa per te? Oppure preferisci esplorare Articoli, Video o News del sito RSM?",
    "Digita: 'cerca [argomento]' per ricerche, o 'articoli'/'video'/'news' per navigare nel sito."
  ];
  
  return randomChoice(genericResponses);
}

// Riassunto semplice
function summarizeText(text, maxSentences = 2) {
  if (!text) return "Non c'√® testo da riassumere.";
  const sentences = text.split(/(?<=[.!?])\s+/);
  return sentences.slice(0, maxSentences).join(' ');
}
</script>
</body>
</html>
